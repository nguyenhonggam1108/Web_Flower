{% extends 'dashboard/base_admin.html' %}
{% load static %}
{% block title %}Th√™m phi·∫øu nh·∫≠p / xu·∫•t{% endblock %}
{% block content %}
<!-- load inventory CSS -->
<link rel="stylesheet" href="{% static 'css/inventory.css' %}">

<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">üìù Th√™m phi·∫øu nh·∫≠p / xu·∫•t nguy√™n li·ªáu</h2>
    <a href="{% url 'dashboard:dashboard' %}" class="btn btn-secondary me-2">‚Üê Quay v·ªÅ Dashboard</a>
  </div>

  <div class="inv-card">
    <form method="post" id="inventoryForm">
      {% csrf_token %}
      <!-- top row: source + category + item + type + clear -->
      <div class="row g-3 align-items-end">
        <div class="col-lg-2 col-sm-6">
          <label class="inv-row-label">Ngu·ªìn</label>
          <select id="item_app" name="item_app" class="form-select">
            <option value="inventory">Hoa l·∫ª</option>
            <option value="accessories">Ph·ª• ki·ªán</option>
          </select>
        </div>

        <div class="col-lg-3 col-sm-6">
          <label class="inv-row-label">Danh m·ª•c</label>
          <select id="category_select" class="form-select">
            <option value="">-- Ch·ªçn danh m·ª•c --</option>

            <optgroup label="Hoa l·∫ª" data-app="inventory" id="optgroup-inventory">
              {% for c in flower_cats %}
                <option value="{{ c.id }}" data-app="inventory">{{ c.name }}</option>
              {% endfor %}
            </optgroup>

            <optgroup label="Ph·ª• ki·ªán" data-app="accessories" id="optgroup-accessories">
              {% for c in accessory_cats %}
                <option value="{{ c.id }}" data-app="accessories">{{ c.name }}</option>
              {% endfor %}
            </optgroup>
          </select>
        </div>

        <div class="col-lg-4 col-sm-12">
          <label class="inv-row-label">V·∫≠t ph·∫©m</label>
          <select id="item_select" name="item_id" class="form-select" required>
            <option value="">-- Ch·ªçn v·∫≠t ph·∫©m --</option>
          </select>
          <input type="hidden" id="item_model" name="item_model" value="FlowerItem">
        </div>

        <div class="col-lg-1 col-sm-6">
          <label class="inv-row-label">Lo·∫°i</label>
          <select id="type_select" name="type" class="form-select">
            <option value="IMPORT">Nh·∫≠p</option>
            <option value="EXPORT">Xu·∫•t</option>
          </select>
        </div>

        <div class="col-lg-2 col-sm-6 text-end">
          <button type="button" id="clear_btn" class="btn btn-outline-secondary">X√≥a ch·ªçn</button>
        </div>
      </div>

      <hr class="my-3">

      <!-- second row: qty / unit price / total / stock -->
      <div class="row g-3 align-items-end">
        <div class="col-lg-2 col-sm-6">
          <label class="inv-row-label">S·ªë l∆∞·ª£ng</label>
          <input type="number" name="quantity" id="quantity_input" class="form-control" min="1" value="1" required>
          <div class="form-text-small">ƒë∆°n v·ªã: b√≥ / c√°i</div>
        </div>

        <div class="col-lg-3 col-sm-6">
          <label class="inv-row-label">ƒê∆°n gi√° (VNƒê)</label>
          <input type="number" step="0.01" id="unit_price" name="unit_price" class="form-control" placeholder="Nh·∫≠p ƒë∆°n gi√° ho·∫∑c ch·ªçn v·∫≠t ph·∫©m">
        </div>

        <div class="col-lg-3 col-sm-6">
          <label class="inv-row-label">T·ªïng ti·ªÅn</label>
          <div class="input-group">
            <span class="input-group-text">‚Ç´</span>
            <input type="text" id="total_value" class="form-control" readonly value="0">
          </div>
        </div>

        <div class="col-lg-2 col-sm-6">
          <label class="inv-row-label">T·ªìn hi·ªán t·∫°i</label>
          <div id="stock_info" class="stock-badge text-muted">-</div>
        </div>

        <div class="col-lg-2 col-sm-12 text-end">
          <button type="submit" id="submit_btn" class="btn btn-primary">L∆∞u</button>
          <a href="{% url 'inventory:list' %}" class="btn btn-outline-secondary ms-2">H·ªßy</a>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- existing JS (unchanged) -->
<script>
document.addEventListener('DOMContentLoaded', function(){
  const FLOWER_CAT_API = '/inventory/api/categories/';
  const ACCESSORY_CAT_API = '/accessories/api/categories/';
  const ITEMS_BY_CATEGORY = (app, cat) => `/inventory/api/items-by-category/${app}/${cat}/`;

  const itemApp = document.getElementById('item_app');
  const categorySelect = document.getElementById('category_select');
  const itemSelect = document.getElementById('item_select');
  const itemModel = document.getElementById('item_model');
  const qtyInput = document.getElementById('quantity_input');
  const unitPrice = document.getElementById('unit_price');
  const totalValue = document.getElementById('total_value');
  const stockInfo = document.getElementById('stock_info');
  const typeSelect = document.getElementById('type_select');
  const submitBtn = document.getElementById('submit_btn');
  const clearBtn = document.getElementById('clear_btn');

  let flowerCats = {% if flower_cats %}{{ flower_cats|safe }}{% else %}[] {% endif %};
  let accCats = {% if accessory_cats %}{{ accessory_cats|safe }}{% else %}[] {% endif %};

  function renderCategoryGroupsByApp(selectedApp){
    const ogInv = document.getElementById('optgroup-inventory');
    const ogAcc = document.getElementById('optgroup-accessories');
    if(!ogInv || !ogAcc) return;
    if(selectedApp === 'inventory'){
      ogInv.removeAttribute('hidden');
      ogAcc.setAttribute('hidden','');
    } else if(selectedApp === 'accessories'){
      ogAcc.removeAttribute('hidden');
      ogInv.setAttribute('hidden','');
    } else {
      ogInv.removeAttribute('hidden');
      ogAcc.removeAttribute('hidden');
    }
  }

  async function fetchCategories() {
    try {
      const r = await fetch(FLOWER_CAT_API);
      if (r.ok) {
        const j = await r.json();
        flowerCats = j;
      }
    } catch(e){}
    try {
      const r2 = await fetch(ACCESSORY_CAT_API);
      if (r2.ok) {
        const j2 = await r2.json();
        accCats = j2;
      }
    } catch(e){}
  }

  async function loadItems(app, catId) {
    itemSelect.innerHTML = '<option>ƒêang t·∫£i...</option>';
    try {
      const resp = await fetch(ITEMS_BY_CATEGORY(app, catId));
      if (!resp.ok) { itemSelect.innerHTML = '<option>Kh√¥ng t·∫£i ƒë∆∞·ª£c</option>'; return; }
      const data = await resp.json();
      itemSelect.innerHTML = '<option value="">-- Ch·ªçn v·∫≠t ph·∫©m --</option>';
      data.forEach(it => {
        const opt = document.createElement('option');
        opt.value = it.id;
        opt.textContent = `${it.name} ‚Äî Gi√°: ${it.price ?? '-'} ‚Äî T:${it.stock ?? '-'}`;
        opt.dataset.price = it.price ?? '';
        opt.dataset.stock = it.stock ?? '';
        itemSelect.appendChild(opt);
      });
    } catch(e) {
      console.error(e);
      itemSelect.innerHTML = '<option>L·ªói</option>';
    }
    updateFromSelection();
  }

  function updateFromSelection() {
    const opt = itemSelect.selectedOptions[0];
    if (!opt || !opt.value) {
      stockInfo.textContent = '-';
      stockInfo.classList.remove('text-danger'); stockInfo.classList.add('text-muted');
      unitPrice.value = '';
      totalValue.value = formatMoney(0);
      itemModel.value = itemApp.value === 'accessories' ? 'AccessoryItem' : 'FlowerItem';
      return;
    }
    const stock = opt.dataset.stock || '';
    const price = opt.dataset.price || '';
    stockInfo.textContent = stock !== '' ? stock : '-';
    stockInfo.classList.remove('text-danger'); stockInfo.classList.add('text-success');
    if (price !== '') unitPrice.value = price;
    itemModel.value = itemApp.value === 'accessories' ? 'AccessoryItem' : 'FlowerItem';
    computeTotal();
    checkStock();
  }

  function computeTotal() {
    const qty = parseFloat(qtyInput.value) || 0;
    const price = parseFloat(unitPrice.value) || 0;
    const total = qty * price;
    totalValue.value = formatMoney(total);
  }

  function checkStock() {
    const opt = itemSelect.selectedOptions[0];
    const stock = opt ? parseFloat(opt.dataset.stock || 0) : 0;
    const qty = parseFloat(qtyInput.value) || 0;
    if (typeSelect.value === 'EXPORT' && qty > stock) {
      stockInfo.classList.remove('text-success'); stockInfo.classList.add('text-danger');
      stockInfo.textContent = `T·ªìn: ${stock} ‚Äî Kh√¥ng ƒë·ªß`;
      submitBtn.disabled = true;
    } else {
      if (opt && opt.dataset.stock) stockInfo.textContent = `${opt.dataset.stock}`;
      submitBtn.disabled = false;
    }
  }

  function formatMoney(v){
    if (isNaN(v)) return '0';
    return new Intl.NumberFormat('vi-VN').format(Math.round(v));
  }

  // events
  itemApp.addEventListener('change', function(){
    renderCategoryGroupsByApp(this.value);
    categorySelect.value = '';
    itemSelect.innerHTML = '<option value="">-- Ch·ªçn v·∫≠t ph·∫©m --</option>';
    stockInfo.textContent = '-'; unitPrice.value = ''; totalValue.value = formatMoney(0);
  });

  categorySelect.addEventListener('change', function(){
    const opt = categorySelect.selectedOptions[0];
    const app = opt && opt.dataset && opt.dataset.app ? opt.dataset.app : itemApp.value;
    const catId = this.value;
    if (!catId) { itemSelect.innerHTML = '<option value="">-- Ch·ªçn v·∫≠t ph·∫©m --</option>'; return; }
    loadItems(app, catId);
  });

  itemSelect.addEventListener('change', updateFromSelection);
  qtyInput.addEventListener('input', function(){ computeTotal(); checkStock(); });
  unitPrice.addEventListener('input', computeTotal);
  typeSelect.addEventListener('change', checkStock);
  clearBtn.addEventListener('click', function(){
    categorySelect.value = ''; itemSelect.innerHTML = '<option value="">-- Ch·ªçn v·∫≠t ph·∫©m --</option>';
    stockInfo.textContent = '-'; unitPrice.value = ''; totalValue.value = formatMoney(0);
  });

  // initial
  (function init(){
    const initial = "{{ item_app_default|default:'inventory' }}";
    try { itemApp.value = initial; } catch(e){}
    renderCategoryGroupsByApp(itemApp.value);
    fetchCategories();
  })();

});
</script>
{% endblock %}